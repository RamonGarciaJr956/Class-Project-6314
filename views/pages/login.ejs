<!DOCTYPE html>
<html lang="en">

<%- include('../partials/head') %>

<body class="bg-gray-900">

  <%- include('../partials/navbar') %>

  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full space-y-8">

      <div class="bg-gray-800/50 backdrop-blur-xl p-8 rounded-2xl border border-white/10 shadow-xl relative overflow-hidden">
        <div class="absolute -right-20 -top-20 w-40 h-40 bg-purple-600/20 rounded-full blur-3xl"></div>
        <div class="absolute -left-20 -bottom-20 w-40 h-40 bg-blue-600/20 rounded-full blur-3xl"></div>

        <div class="relative">
          <h2 class="text-3xl font-bold text-white mb-6 text-center">Welcome Back</h2>

          <div class="space-y-6">
            <button type="button" onclick="loginWithDiscord()" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-semibold py-3 px-4 rounded-lg flex justify-center gap-2 group transition-all duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="fill-white w-6 h-6">
                <!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                <path d="M524.5 69.8a1.5 1.5 0 0 0 -.8-.7A485.1 485.1 0 0 0 404.1 32a1.8 1.8 0 0 0 -1.9 .9 337.5 337.5 0 0 0 -14.9 30.6 447.8 447.8 0 0 0 -134.4 0 309.5 309.5 0 0 0 -15.1-30.6 1.9 1.9 0 0 0 -1.9-.9A483.7 483.7 0 0 0 116.1 69.1a1.7 1.7 0 0 0 -.8 .7C39.1 183.7 18.2 294.7 28.4 404.4a2 2 0 0 0 .8 1.4A487.7 487.7 0 0 0 176 479.9a1.9 1.9 0 0 0 2.1-.7A348.2 348.2 0 0 0 208.1 430.4a1.9 1.9 0 0 0 -1-2.6 321.2 321.2 0 0 1 -45.9-21.9 1.9 1.9 0 0 1 -.2-3.1c3.1-2.3 6.2-4.7 9.1-7.1a1.8 1.8 0 0 1 1.9-.3c96.2 43.9 200.4 43.9 295.5 0a1.8 1.8 0 0 1 1.9 .2c2.9 2.4 6 4.9 9.1 7.2a1.9 1.9 0 0 1 -.2 3.1 301.4 301.4 0 0 1 -45.9 21.8 1.9 1.9 0 0 0 -1 2.6 391.1 391.1 0 0 0 30 48.8 1.9 1.9 0 0 0 2.1 .7A486 486 0 0 0 610.7 405.7a1.9 1.9 0 0 0 .8-1.4C623.7 277.6 590.9 167.5 524.5 69.8zM222.5 337.6c-29 0-52.8-26.6-52.8-59.2S193.1 219.1 222.5 219.1c29.7 0 53.3 26.8 52.8 59.2C275.3 311 251.9 337.6 222.5 337.6zm195.4 0c-29 0-52.8-26.6-52.8-59.2S388.4 219.1 417.9 219.1c29.7 0 53.3 26.8 52.8 59.2C470.7 311 447.5 337.6 417.9 337.6z" />
              </svg>
              <span>Continue with Discord</span>
            </button>

            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-white/10"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-[#18212f] text-gray-400">Or continue with email</span>
              </div>
            </div>

            <form class="space-y-6" action="/auth/callback/credentials" method="post">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <div class="relative">
                  <div class="absolute left-3 top-3 text-gray-400">
                    <i class="w-5 h-5" data-lucide="mail"></i>
                  </div>
                  <input required name="email" type="email" class="w-full bg-gray-900/50 border border-white/10 rounded-lg pl-10 pr-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="Enter your email">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <div class="relative">
                  <div class="absolute left-3 top-3 text-gray-400">
                    <i class="w-5 h-5" data-lucide="lock"></i>
                  </div>
                  <input required name="password" type="password" class="w-full bg-gray-900/50 border border-white/10 rounded-lg pl-10 pr-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="Enter your password">
                </div>
              </div>

              <div class="text-right">
                <a href="/forgot-password" class="text-sm text-purple-400 hover:text-purple-300">Forgot password?</a>
              </div>

              <button class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center group transition-all duration-300">
                <span>Sign In</span>
                <i class="w-5 h-5 ml-2 transition-transform duration-300 group-hover:translate-x-1" data-lucide="arrow-right"></i>
              </button>
            </form>

            <p class="mt-6 text-center text-sm text-gray-400">
              Don't have an account?
              <a href="/register" class="text-purple-400 hover:text-purple-300 font-medium">Sign up</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    async function loginWithDiscord() {
      try {
        const csrfResponse = await fetch('/auth/csrf', {
          credentials: 'same-origin'
        });

        if (!csrfResponse.ok) {
          throw new Error('Failed to fetch CSRF token');
        }

        const {
          csrfToken
        } = await csrfResponse.json();

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/auth/signin/discord';

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfToken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        const callbackInput = document.createElement('input');
        callbackInput.type = 'hidden';
        callbackInput.name = 'callbackUrl';
        callbackInput.value = 'http://localhost:8080';
        form.appendChild(callbackInput);

        document.body.appendChild(form);
        form.submit();

        document.body.removeChild(form);

      } catch (error) {
        console.error('Login error:', error);
        alert(error.message || 'An error occurred during login. Please try again.');
      }
    }

    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'csrfToken';

    fetch('/auth/csrf').then(csrfResponse => {
      if (!csrfResponse.ok) {
        throw new Error('Failed to fetch CSRF token');
      }

      csrfResponse.json().then(json => {
        input.value = json.csrfToken;

        document.querySelector('form').append(input);
      });
    });

    async function login(event) {
      event.preventDefault();

      try {
        const email = document.querySelector('input[type="email"]').value.trim();
        const password = document.querySelector('input[type="password"]').value;
        const form = document.querySelector('form');

        const csrfResponse = await fetch('/auth/csrf');
        if (!csrfResponse.ok) {
          throw new Error('Failed to fetch CSRF token');
        }
        const {
          csrfToken
        } = await csrfResponse.json();

        const response = await fetch('/auth/callback/credentials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            csrfToken,
            email,
            password,
          })
        });

        if (response.ok) {

          if (response.url.includes('code=')) {
            const codeType = new URL(response.url).searchParams.get('code');
            if (codeType == 'credentials') {
              form.reset();
              throw new Error('Invalid credentials please try again.');
            }
          } else if (response.url.includes('error=')) {
            const errorType = new URL(response.url).searchParams.get('error');
            throw new Error(`Authentication failed please try again. Error: ${errorType}`);
          }
        } else {
          throw new Error('Login failed');
        }

      } catch (error) {
        console.error('Login error:', error);
        alert(error.message || 'An error occurred during login. Please try again.');
      }
    }
  </script>
</body>

<%- include('../partials/footer') %>

</html>